package router

import (
	"encoding/json"
	"io"
	"net/http"
	"regexp"
	"strings"
)

type Incoming struct {
	Text string
}

type Outgoing struct {
	Text  []string `json:"text"`
	Tags  []string `json:"tags"`
	Emoji []string `json:"emoji"`
}

func Filter(vs []string, f func(string) bool) []string {
	vsf := make([]string, 0)
	for _, v := range vs {
		if f(v) {
			vsf = append(vsf, v)
		}
	}
	return vsf
}

func Map(vs []string, f func(string) string) []string {
	vsm := make([]string, len(vs))
	for i, v := range vs {
		vsm[i] = f(v)
	}
	return vsm
}

func TextFormatter(response http.ResponseWriter, request *http.Request) {

	// JSON
	decoder := json.NewDecoder(request.Body)
	var data Incoming
	err := decoder.Decode(&data)
	if err != nil {
		io.WriteString(response, "json data not valid")
		return
	}

	// Basic Modifications
	text := strings.ToLower(data.Text)
	emojiRegex := `ðŸ˜„|ðŸ˜ƒ|ðŸ˜€|ðŸ˜Š|â˜ºï¸|ðŸ˜‰|ðŸ˜|ðŸ˜˜|ðŸ˜š|ðŸ˜—|ðŸ˜™|ðŸ˜œ|ðŸ˜|ðŸ˜›|ðŸ˜³|ðŸ˜|ðŸ˜”|ðŸ˜Œ|ðŸ˜’|ðŸ˜ž|ðŸ˜£|ðŸ˜¢|ðŸ˜‚|ðŸ˜­|ðŸ˜ª|ðŸ˜¥|ðŸ˜°|ðŸ˜…|ðŸ˜“|ðŸ˜©|ðŸ˜«|ðŸ˜¨|ðŸ˜±|ðŸ˜ |ðŸ˜¡|ðŸ˜¤|ðŸ˜–|ðŸ˜†|ðŸ˜‹|ðŸ˜·|ðŸ˜Ž|ðŸ˜´|ðŸ˜µ|ðŸ˜²|ðŸ˜Ÿ|ðŸ˜¦|ðŸ˜§|ðŸ˜ˆ|ðŸ‘¿|ðŸ˜®|ðŸ˜¬|ðŸ˜|ðŸ˜•|ðŸ˜¯|ðŸ˜¶|ðŸ˜‡|ðŸ˜|ðŸ˜‘|ðŸ‘²|ðŸ‘³|ðŸ‘®|ðŸ‘·|ðŸ’‚|ðŸ‘¶|ðŸ‘¦|ðŸ‘§|ðŸ‘¨|ðŸ‘©|ðŸ‘´|ðŸ‘µ|ðŸ‘±|ðŸ‘¼|ðŸ‘¸|ðŸ˜º|ðŸ˜¸|ðŸ˜»|ðŸ˜½|ðŸ˜¼|ðŸ™€|ðŸ˜¿|ðŸ˜¹|ðŸ˜¾|ðŸ‘¹|ðŸ‘º|ðŸ™ˆ|ðŸ™‰|ðŸ™Š|ðŸ’€|ðŸ‘½|ðŸ’©|ðŸ”¥|âœ¨|ðŸŒŸ|ðŸ’«|ðŸ’¥|ðŸ’¢|ðŸ’¦|ðŸ’§|ðŸ’¤|ðŸ’¨|ðŸ‘‚|ðŸ‘€|ðŸ‘ƒ|ðŸ‘…|ðŸ‘„|ðŸ‘|ðŸ‘Ž|ðŸ‘Œ|ðŸ‘Š|âœŠ|âœŒï¸|ðŸ‘‹|âœ‹|ðŸ‘|ðŸ‘†|ðŸ‘‡|ðŸ‘‰|ðŸ‘ˆ|ðŸ™Œ|ðŸ™|â˜ï¸|ðŸ‘|ðŸ’ª|ðŸš¶|ðŸƒ|ðŸ’ƒ|ðŸ‘«|ðŸ‘ª|ðŸ‘¬|ðŸ‘­|ðŸ’|ðŸ’‘|ðŸ‘¯|ðŸ™†|ðŸ™…|ðŸ’|ðŸ™‹|ðŸ’†|ðŸ’‡|ðŸ’…|ðŸ‘°|ðŸ™Ž|ðŸ™|ðŸ™‡|ðŸŽ©|ðŸ‘‘|ðŸ‘’|ðŸ‘Ÿ|ðŸ‘ž|ðŸ‘¡|ðŸ‘ |ðŸ‘¢|ðŸ‘•|ðŸ‘”|ðŸ‘š|ðŸ‘—|ðŸŽ½|ðŸ‘–|ðŸ‘˜|ðŸ‘™|ðŸ’¼|ðŸ‘œ|ðŸ‘|ðŸ‘›|ðŸ‘“|ðŸŽ€|ðŸŒ‚|ðŸ’„|ðŸ’›|ðŸ’™|ðŸ’œ|ðŸ’š|â¤ï¸|ðŸ’”|ðŸ’—|ðŸ’“|ðŸ’•|ðŸ’–|ðŸ’ž|ðŸ’˜|ðŸ’Œ|ðŸ’‹|ðŸ’|ðŸ’Ž|ðŸ‘¤|ðŸ‘¥|ðŸ’¬|ðŸ‘£|ðŸ’­|ðŸ¶|ðŸº|ðŸ±|ðŸ­|ðŸ¹|ðŸ°|ðŸ¸|ðŸ¯|ðŸ¨|ðŸ»|ðŸ·|ðŸ½|ðŸ®|ðŸ—|ðŸµ|ðŸ’|ðŸ´|ðŸ‘|ðŸ˜|ðŸ¼|ðŸ§|ðŸ¦|ðŸ¤|ðŸ¥|ðŸ£|ðŸ”|ðŸ|ðŸ¢|ðŸ›|ðŸ|ðŸœ|ðŸž|ðŸŒ|ðŸ™|ðŸš|ðŸ |ðŸŸ|ðŸ¬|ðŸ³|ðŸ‹|ðŸ„|ðŸ|ðŸ€|ðŸƒ|ðŸ…|ðŸ‡|ðŸ‰|ðŸŽ|ðŸ|ðŸ“|ðŸ•|ðŸ–|ðŸ|ðŸ‚|ðŸ²|ðŸ¡|ðŸŠ|ðŸ«|ðŸª|ðŸ†|ðŸˆ|ðŸ©|ðŸ¾|ðŸ’|ðŸŒ¸|ðŸŒ·|ðŸ€|ðŸŒ¹|ðŸŒ»|ðŸŒº|ðŸ|ðŸƒ|ðŸ‚|ðŸŒ¿|ðŸŒ¾|ðŸ„|ðŸŒµ|ðŸŒ´|ðŸŒ²|ðŸŒ³|ðŸŒ°|ðŸŒ±|ðŸŒ¼|ðŸŒ|ðŸŒž|ðŸŒ|ðŸŒš|ðŸŒ‘|ðŸŒ’|ðŸŒ“|ðŸŒ”|ðŸŒ•|ðŸŒ–|ðŸŒ—|ðŸŒ˜|ðŸŒœ|ðŸŒ›|ðŸŒ™|ðŸŒ|ðŸŒŽ|ðŸŒ|ðŸŒ‹|ðŸŒŒ|ðŸŒ |â­|â˜€ï¸|â›…|â˜ï¸|âš¡|â˜”|â„ï¸|â›„|ðŸŒ€|ðŸŒ|ðŸŒˆ|ðŸŒŠ|ðŸŽ|ðŸ’|ðŸŽŽ|ðŸŽ’|ðŸŽ“|ðŸŽ|ðŸŽ†|ðŸŽ‡|ðŸŽ|ðŸŽ‘|ðŸŽƒ|ðŸ‘»|ðŸŽ…|ðŸŽ„|ðŸŽ|ðŸŽ‹|ðŸŽ‰|ðŸŽŠ|ðŸŽˆ|ðŸŽŒ|ðŸ”®|ðŸŽ¥|ðŸ“·|ðŸ“¹|ðŸ“¼|ðŸ’¿|ðŸ“€|ðŸ’½|ðŸ’¾|ðŸ’»|ðŸ“±|â˜Žï¸|ðŸ“ž|ðŸ“Ÿ|ðŸ“ |ðŸ“¡|ðŸ“º|ðŸ“»|ðŸ”Š|ðŸ”‰|ðŸ”ˆ|ðŸ”‡|ðŸ””|ðŸ”•|ðŸ“¢|ðŸ“£|â³|âŒ›|â°|âŒš|ðŸ”“|ðŸ”’|ðŸ”|ðŸ”|ðŸ”‘|ðŸ”Ž|ðŸ’¡|ðŸ”¦|ðŸ”†|ðŸ”…|ðŸ”Œ|ðŸ”‹|ðŸ”|ðŸ›|ðŸ›€|ðŸš¿|ðŸš½|ðŸ”§|ðŸ”©|ðŸ”¨|ðŸšª|ðŸš¬|ðŸ’£|ðŸ”«|ðŸ”ª|ðŸ’Š|ðŸ’‰|ðŸ’°|ðŸ’´|ðŸ’µ|ðŸ’·|ðŸ’¶|ðŸ’³|ðŸ’¸|ðŸ“²|ðŸ“§|ðŸ“¥|ðŸ“¤|âœ‰ï¸|ðŸ“©|ðŸ“¨|ðŸ“¯|ðŸ“«|ðŸ“ª|ðŸ“¬|ðŸ“­|ðŸ“®|ðŸ“¦|ðŸ“|ðŸ“„|ðŸ“ƒ|ðŸ“‘|ðŸ“Š|ðŸ“ˆ|ðŸ“‰|ðŸ“œ|ðŸ“‹|ðŸ“…|ðŸ“†|ðŸ“‡|ðŸ“|ðŸ“‚|âœ‚ï¸|ðŸ“Œ|ðŸ“Ž|âœ’ï¸|âœï¸|ðŸ“|ðŸ“|ðŸ“•|ðŸ“—|ðŸ“˜|ðŸ“™|ðŸ““|ðŸ“”|ðŸ“’|ðŸ“š|ðŸ“–|ðŸ”–|ðŸ“›|ðŸ”¬|ðŸ”­|ðŸ“°|ðŸŽ¨|ðŸŽ¬|ðŸŽ¤|ðŸŽ§|ðŸŽ¼|ðŸŽµ|ðŸŽ¶|ðŸŽ¹|ðŸŽ»|ðŸŽº|ðŸŽ·|ðŸŽ¸|ðŸ‘¾|ðŸŽ®|ðŸƒ|ðŸŽ´|ðŸ€„|ðŸŽ²|ðŸŽ¯|ðŸˆ|ðŸ€|âš½|âš¾ï¸|ðŸŽ¾|ðŸŽ±|ðŸ‰|ðŸŽ³|â›³|ðŸšµ|ðŸš´|ðŸ|ðŸ‡|ðŸ†|ðŸŽ¿|ðŸ‚|ðŸŠ|ðŸ„|ðŸŽ£|â˜•|ðŸµ|ðŸ¶|ðŸ¼|ðŸº|ðŸ»|ðŸ¸|ðŸ¹|ðŸ·|ðŸ´|ðŸ•|ðŸ”|ðŸŸ|ðŸ—|ðŸ–|ðŸ|ðŸ›|ðŸ¤|ðŸ±|ðŸ£|ðŸ¥|ðŸ™|ðŸ˜|ðŸš|ðŸœ|ðŸ²|ðŸ¢|ðŸ¡|ðŸ³|ðŸž|ðŸ©|ðŸ®|ðŸ¦|ðŸ¨|ðŸ§|ðŸŽ‚|ðŸ°|ðŸª|ðŸ«|ðŸ¬|ðŸ­|ðŸ¯|ðŸŽ|ðŸ|ðŸŠ|ðŸ‹|ðŸ’|ðŸ‡|ðŸ‰|ðŸ“|ðŸ‘|ðŸˆ|ðŸŒ|ðŸ|ðŸ|ðŸ |ðŸ†|ðŸ…|ðŸŒ½|ðŸ |ðŸ¡|ðŸ«|ðŸ¢|ðŸ£|ðŸ¥|ðŸ¦|ðŸª|ðŸ©|ðŸ¨|ðŸ’’|â›ª|ðŸ¬|ðŸ¤|ðŸŒ‡|ðŸŒ†|ðŸ¯|ðŸ°|â›º|ðŸ­|ðŸ—¼|ðŸ—¾|ðŸ—»|ðŸŒ„|ðŸŒ…|ðŸŒƒ|ðŸ—½|ðŸŒ‰|ðŸŽ |ðŸŽ¡|â›²|ðŸŽ¢|ðŸš¢|â›µ|ðŸš¤|ðŸš£|âš“|ðŸš€|âœˆï¸|ðŸ’º|ðŸš|ðŸš‚|ðŸšŠ|ðŸš‰|ðŸšž|ðŸš†|ðŸš„|ðŸš…|ðŸšˆ|ðŸš‡|ðŸš|ðŸš‹|ðŸšƒ|ðŸšŽ|ðŸšŒ|ðŸš|ðŸš™|ðŸš˜|ðŸš—|ðŸš•|ðŸš–|ðŸš›|ðŸšš|ðŸš¨|ðŸš“|ðŸš”|ðŸš’|ðŸš‘|ðŸš|ðŸš²|ðŸš¡|ðŸšŸ|ðŸš |ðŸšœ|ðŸ’ˆ|ðŸš|ðŸŽ«|ðŸš¦|ðŸš¥|âš ï¸|ðŸš§|ðŸ”°|â›½|ðŸ®|ðŸŽ°|â™¨ï¸|ðŸ—¿|ðŸŽª|ðŸŽ­|ðŸ“|ðŸš©|ðŸ‡¯ðŸ‡µ|ðŸ‡°ðŸ‡·|ðŸ‡©ðŸ‡ª|ðŸ‡¨ðŸ‡³|ðŸ‡ºðŸ‡¸|ðŸ‡«ðŸ‡·|ðŸ‡ªðŸ‡¸|ðŸ‡®ðŸ‡¹|ðŸ‡·ðŸ‡º|ðŸ‡¬ðŸ‡§|1ï¸âƒ£|2ï¸âƒ£|3ï¸âƒ£|4ï¸âƒ£|5ï¸âƒ£|6ï¸âƒ£|7ï¸âƒ£|8ï¸âƒ£|9ï¸âƒ£|0ï¸âƒ£|ðŸ”Ÿ|ðŸ”¢|#ï¸âƒ£|ðŸ”£|â¬†ï¸|â¬‡ï¸|â¬…ï¸|âž¡ï¸|ðŸ” |ðŸ”¡|ðŸ”¤|â†—ï¸|â†–ï¸|â†˜ï¸|â†™ï¸|â†”ï¸|â†•ï¸|ðŸ”„|â—€ï¸|â–¶ï¸|ðŸ”¼|ðŸ”½|â†©ï¸|â†ªï¸|â„¹ï¸|âª|â©|â«|â¬|â¤µï¸|â¤´ï¸|ðŸ†—|ðŸ”€|ðŸ”|ðŸ”‚|ðŸ†•|ðŸ†™|ðŸ†’|ðŸ†“|ðŸ†–|ðŸ“¶|ðŸŽ¦|ðŸˆ|ðŸˆ¯|ðŸˆ³|ðŸˆµ|ðŸˆ´|ðŸˆ²|ðŸ‰|ðŸˆ¹|ðŸˆº|ðŸˆ¶|ðŸˆš|ðŸš»|ðŸš¹|ðŸšº|ðŸš¼|ðŸš¾|ðŸš°|ðŸš®|ðŸ…¿ï¸|â™¿|ðŸš­|ðŸˆ·ï¸|ðŸˆ¸|ðŸˆ‚ï¸|â“‚ï¸|ðŸ›‚|ðŸ›„|ðŸ›…|ðŸ›ƒ|ðŸ‰‘|ãŠ™ï¸|ãŠ—ï¸|ðŸ†‘|ðŸ†˜|ðŸ†”|ðŸš«|ðŸ”ž|ðŸ“µ|ðŸš¯|ðŸš±|ðŸš³|ðŸš·|ðŸš¸|â›”|âœ³ï¸|â‡ï¸|âŽ|âœ…|âœ´ï¸|ðŸ’Ÿ|ðŸ†š|ðŸ“³|ðŸ“´|ðŸ…°ï¸|ðŸ…±ï¸|ðŸ†Ž|ðŸ…¾ï¸|ðŸ’ |âž¿|â™»ï¸|â™ˆ|â™‰|â™Š|â™‹|â™Œ|â™|â™Ž|â™|â™|â™‘|â™’|â™“|â›Ž|ðŸ”¯|ðŸ§|ðŸ’¹|ðŸ’²|ðŸ’±|Â©ï¸|Â®ï¸|â„¢ï¸|âŒ|â€¼ï¸|â‰ï¸|â—|â“|â•|â”|â­•|ðŸ”|ðŸ”š|ðŸ”™|ðŸ”›|ðŸ”œ|ðŸ”ƒ|ðŸ•›|ðŸ•§|ðŸ•|ðŸ•œ|ðŸ•‘|ðŸ•|ðŸ•’|ðŸ•ž|ðŸ•“|ðŸ•Ÿ|ðŸ•”|ðŸ• |ðŸ••|ðŸ•–|ðŸ•—|ðŸ•˜|ðŸ•™|ðŸ•š|ðŸ•¡|ðŸ•¢|ðŸ•£|ðŸ•¤|ðŸ•¥|ðŸ•¦|âœ–ï¸|âž•|âž–|âž—|â™ ï¸|â™¥ï¸|â™£ï¸|â™¦ï¸|ðŸ’®|ðŸ’¯|âœ”ï¸|â˜‘ï¸|ðŸ”˜|ðŸ”—|âž°|ã€°ï¸|ã€½ï¸|ðŸ”±|â—¼ï¸|â—»ï¸|â—¾|â—½|â–ªï¸|â–«ï¸|ðŸ”º|ðŸ”²|ðŸ”³|âš«|âšª|ðŸ”´|ðŸ”µ|ðŸ”»|â¬œ|â¬›|ðŸ”¶|ðŸ”·|ðŸ”¸|ðŸ”¹`
	textRegex := `([^Ð-Ð¯ÐÐ°-ÑÑ‘A-Za-z1-9# ])`
	hashTagRegex := `\S*#(?:\[[^\]]+\]|\S+)`

	// Emoji
	re, err := regexp.Compile(emojiRegex)
	emoji := re.FindAllString(text, -1)

	// Tags
	text = re.ReplaceAllString(text, "")
	text = strings.Replace(text, "#", " #", -1)
	re, err = regexp.Compile(textRegex)
	text = re.ReplaceAllString(text, " ")
	re, err = regexp.Compile(hashTagRegex)
	tags := re.FindAllString(text, -1)
	tags = Map(tags, func(v string) string {
		return strings.Replace(v, "#", "", -1)
	})

	// Words
	text = re.ReplaceAllString(text, "")
	words := strings.Split(text, " ")
	wordsData := Filter(words, func(v string) bool {
		if len(v) > 3 {
			return true
		} else {
			return false
		}
	})

	// Response
	result := Outgoing{wordsData, tags, emoji}
	res, err := json.Marshal(result)
	if err != nil {
		http.Error(response, err.Error(), http.StatusInternalServerError)
		return
	}
	response.Header().Set("Content-Type", "application/json")
	response.Write(res)

}
